#!/bin/sh
# pre-push hook - Fixed version

current_branch=$(git rev-parse --abbrev-ref HEAD)

# Block direct pushes to protected branches
case "$current_branch" in
    main|development)
        echo "âŒ Direct push to $current_branch blocked!"
        echo "âœ… Use Pull Request workflow"
        exit 1
        ;;
esac

# Get the branch this was created from - FIXED METHOD
parent=$(git reflog show --format="%gs" HEAD | grep "checkout: moving from" | head -1 | awk '{print $4}')

echo "ğŸ” Debug info:"
echo "  Current branch: $current_branch"
echo "  Detected parent: '$parent'"

# Validate branch pattern and parent
case "$current_branch" in
    hotfix/*)
        if [ "$parent" != "main" ]; then
            echo "âŒ Hotfix must be from main, found: $parent"
            exit 1
        fi
        ;;
    feature/*|release/*)  
        if [ "$parent" != "development" ]; then
            echo "âŒ Feature/Release must be from development, found: $parent"
            exit 1
        fi
        ;;
    *)
        echo "âŒ Invalid branch name: $current_branch"
        echo "âœ… Use: feature/*, hotfix/*, release/*"
        exit 1
        ;;
esac

echo "âœ… Branch validation passed!"



# echo "ğŸ” Checking lint..."
# if [ -f "package.json" ] && grep -q '"lint"' package.json; then
#     if npm run lint >/dev/null 2>&1; then
#         echo "âœ… Lint check passed!"
#     else
#         echo "âŒ Lint check failed!"
#         echo "ğŸ”§ Please fix lint errors:"
#         echo "   npm run lint"
#         echo "   # Fix any errors shown"
#         echo "   # Then push again"
#         echo ""
#         echo "ğŸ’¡ If lint passes manually but hook still fails, use: git push --no-verify"
#         exit 1
#     fi
# else
#     echo "âš ï¸  No lint script found in package.json"
# fi

# echo "ğŸ‰ All validations passed! Push allowed."


# Git Desktop compatible lint check
echo "ğŸ” Checking lint compatibility..."

if [ -f "package.json" ] && grep -q '"lint"' package.json; then
    # Detect if we're running in Git Desktop (check for common Git Desktop indicators)
    if [ -n "$GIT_EXEC_PATH" ] && (echo "$GIT_EXEC_PATH" | grep -qi "desktop\|github desktop\|GitHubDesktop"); then
        echo "ğŸ–¥ï¸  Git Desktop detected - using manual lint verification"
        echo "âš ï¸  Please ensure you've run 'npm run lint' in terminal and it passed"
        echo "âœ… Trusting manual lint verification for Git Desktop"
    else
        # Try running lint for terminal/command line usage
        if npm run lint >/dev/null 2>&1; then
            echo "âœ… Lint check passed!"
        else
            echo "âŒ Lint check failed!"
            echo "ğŸ”§ Please fix lint errors:"
            echo "   npm run lint"
            echo "   # Fix any errors shown"
            echo "   # Then push again"
            exit 1
        fi
    fi
else
    echo "âš ï¸  No lint script found in package.json"
fi

echo "ğŸ‰ All validations passed! Push allowed."